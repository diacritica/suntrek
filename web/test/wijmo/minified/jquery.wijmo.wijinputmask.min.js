/*
 *
 * Wijmo Library 2.2.0
 * http://wijmo.com/
 *
 * Copyright(c) GrapeCity, Inc.  All rights reserved.
 * 
 * Dual licensed under the Wijmo Commercial or GNU GPL Version 3 licenses.
 * licensing@wijmo.com
 * http://wijmo.com/license
 *
 *
 **/
(function(b){"use strict";var a={editOptional:1,editRequired:2,separator:4,literal:8},c,d;b.widget("wijmo.wijinputmask",b.extend(true,{},wijinputcore,{options:{text:null,mask:"",promptChar:"_",hidePromptOnLeave:false,resetOnPrompt:true,allowPromptAsInput:false,passwordChar:"",resetOnSpace:true,skipLiterals:true},_createTextProvider:function(){this._textProvider=new c(this,this.options.mask,false)},_beginUpdate:function(){this.element.addClass("wijmo-wijinput-mask");this.element.data("isPassword",this.options.passwordChar.length>0&&this.element.attr("type")!=="password");this.element.data("defaultText",this.options.text)},_onTriggerClicked:function(){this._popupComboList()},_setOption:function(d,a){b.Widget.prototype._setOption.apply(this,arguments);wijinputcore._setOption.apply(this,arguments);switch(d){case"text":this.setText(a);break;case"mask":case"culture":if(typeof a==="undefined"||a.length<=0)return;var c=this.getText();this._textProvider.mask=a;this._textProvider.initialMask=a;this._textProvider.initialize();this._textProvider.set(c);this._updateText();break;case"promptChar":if(!!this._textProvider){this._textProvider.updatePromptChar();this._updateText()}break;case"hidePromptOnLeave":case"resetOnPrompt":this._updateText();break;case"passwordChar":this.element.data("isPassword",(a+"").length>0);this._updateText()}},_resetData:function(){var a=this.element.data("defaultText");if(a===undefined||a===null)a=this.element.data("elementValue");if(a===undefined||a===null)a="";this.setText(a)},_isPassword:function(){return!!this.element.data("isPassword")},_getTextWithPrompts:function(){return!this._isInitialized()?this.element.val():this._textProvider.toString(true,true,false)},_getTextWithLiterals:function(){return!this._isInitialized()?this.element.val():this._textProvider.toString(true,false,true)},_getTextWithPromptAndLiterals:function(){return!this._isInitialized()?this.element.val():this._textProvider.toString(true,true,true)},_onChange:function(){if(!this.element)return;var b=this.element.val(),a=this.getText();if(a!==b){a=this._getTextWithPrompts();if(a!==b){a=this._getTextWithPromptAndLiterals();a!==b&&this.setText(b)}}},_afterFocused:function(){(this._isNullText()||!!this.options.hidePromptOnLeave)&&this._doFocus()}}));c=function(c,b,a){this.inputWidget=c;this.mask=b;this.asciiOnly=a;this.descriptors=[];this.noMask=false;this.initialize()};c.prototype={inputWidget:undefined,noMask:false,mask:"",testString:"",assignedCharCount:0,requiredCharCount:0,asciiOnly:false,initialize:function(){this.noMask=!this.mask||this.mask.length<=0;if(this.noMask)return;this.testString="";this.assignedCharCount=0;this.requiredCharCount=0;this.descriptors=new Array(0);for(var i="none",m=false,o=0,l,b,c=a.literal,e="",g,n,f,j,h=this.inputWidget._getCulture(),k=0;k<this.mask.length;k++){b=false;g=this.mask.charAt(k);if(m){m=false;b=true}if(!b){f=g;if(f<="C"){switch(f){case"#":case"9":case"?":case"C":g=this.getPromtChar();c=a.editOptional;b=true;break;case"$":e=h.numberFormat.currency.symbol;c=a.separator;b=true;break;case"%":case"-":case";":case"=":case"@":case"B":c=a.literal;b=true;break;case"&":case"0":case"A":g=this.getPromtChar();c=a.editRequired;b=true;break;case",":e=h.numberFormat[","];c=a.separator;b=true;break;case".":e=h.numberFormat["."];c=a.separator;b=true;break;case"/":e=h.calendars.standard["/"];c=a.separator;b=true;break;case":":e=h.calendars.standard[":"];c=a.separator;b=true;break;case"<":i="lower";continue;case">":i="upper";continue}if(!b){c=a.literal;b=true}}if(!b){if(f<="\\"){switch(f){case"L":g=this.getPromtChar();c=a.editRequired;b=true;break;case"\\":m=true;c=a.literal;continue}if(!b){c=a.literal;b=true}}if(!b){if(f==="a"){g=this.getPromtChar();c=a.editOptional;b=true}if(!b){if(f!=="|"){c=a.literal;b=true}if(!b){i="none";continue}}}}}if(b){j=new d(k,c);if(this.isEditDesc(j))j.caseConversion=i;if(c!==a.separator)e=g;for(l=0;l<e.length;l++){n=e.charAt(l);this.testString=this.testString+n;this.descriptors[this.descriptors.length]=j;o++}}}this.testString.Capacity=this.testString.length},getAllowPromptAsInput:function(){return!!this.inputWidget?this.inputWidget.options.allowPromptAsInput:false},getPasswordChar:function(){return!!this.inputWidget?this.inputWidget.options.passwordChar:"*"},isPassword:function(){return!!this.inputWidget?this.inputWidget._isPassword():false},getResetOnPrompt:function(){return!!this.inputWidget?this.inputWidget.options.resetOnPrompt:true},getResetOnSpace:function(){return!!this.inputWidget?this.inputWidget.options.resetOnSpace:true},getSkipLiterals:function(){return!!this.inputWidget?this.inputWidget.options.skipLiterals:true},getHidePromptOnLeave:function(){return!!this.inputWidget?this.inputWidget.options.hidePromptOnLeave:false},_trueOR:function(a,b){return(a>>>1|b>>>1)*2+(a&1|b&1)},setValue:function(){return false},getValue:function(){return null},getPromtChar:function(){return!!this.inputWidget?this.inputWidget.options.promptChar:"_"},updatePromptChar:function(){if(this.noMask)return;for(var c,d=0;d<this.descriptors.length;d++){c=this.descriptors[d];if(c.charType===a.editOptional||c.charType===a.editRequired)if(!c.isAssigned)this.testString=b.wij.charValidator.setChar(this.testString,this.getPromtChar(),d)}},resetChar:function(c){var d=this.descriptors[c];if(this.isEditPos(c)&&d.isAssigned){d.isAssigned=false;this.testString=b.wij.charValidator.setChar(this.testString,this.getPromtChar(),c);this.assignedCharCount--;if(d.charType===a.editRequired)this.requiredCharCount--}},getAdjustedPos:function(a){if(this.noMask){if(a>=this.testString.length)a=this.testString.length-1}else if(a>=this.descriptors.length)a=a-1;return Math.max(0,a)},incEnumPart:function(){return!this.noMask},decEnumPart:function(){return!this.noMask},findNonEditPositionInRange:function(c,d,b){return this.findPositionInRange(c,d,b,this._trueOR(a.literal,a.separator))},findPositionInRange:function(a,b,e,f){a=Math.max(0,a);b=Math.min(b,this.testString.length-1);if(a<=b)while(a<=b){var c=e?a++:b--,d=this.descriptors[c];if((d.charType&4294967295&f&4294967295)===d.charType)return c}return-1},findAssignedEditPositionInRange:function(c,d,b){return this.assignedCharCount===0?-1:this.findEditPositionInRange(c,d,b,a.editRequired)},findEditPositionInRange:function(c,d,f,g){do{var b,e;b=this.findPositionInRange(c,d,f,this._trueOR(a.editRequired,a.editOptional));if(b===-1)break;e=this.descriptors[b];switch(g){case a.editOptional:if(!e.isAssigned)return b;break;case a.editRequired:if(e.isAssigned)return b;break;default:return b}if(f)c++;else d--}while(c<=d);return-1},findAssignedEditPositionFrom:function(d,c){if(!this.assignedCharCount)return-1;var a,b;if(c){a=d;b=this.testString.length-1}else{a=0;b=d}return this.findAssignedEditPositionInRange(a,b,c)},findEditPositionFrom:function(d,c){var a,b;if(c){a=d;b=this.testString.length-1}else{a=0;b=d}return this.findEditPositionInRange(a,b,c,0)},setChar:function(c,e,d){e=e<0?0:e;if(!d)d=this.descriptors[e];if(this.testEscapeChar(c,e,d))this.resetChar(e);else{if(b.wij.charValidator.isLetter(c))if(b.wij.charValidator.isUpper(c)){if(d.caseConversion==="lower")c=c.toLowerCase()}else if(d.caseConversion==="upper")c=c.toUpperCase();this.testString=b.wij.charValidator.setChar(this.testString,c,e);if(!d.isAssigned){d.isAssigned=true;this.assignedCharCount++;if(d.charType===a.editRequired)this.requiredCharCount++}}},internalInsertAt:function(h,e,a,k){if(h.length===0){a.testPosition=e;a.hint=a.noEffect;return true}if(!this._testString(h,e,a))return false;var b=this.findEditPositionFrom(e,true),g=this.findAssignedEditPositionInRange(b,a.testPosition,true)!==-1,l=this.findAssignedEditPositionFrom(this.testString.length-1,false),c,d,f,j,i;if(g&&a.testPosition===this.testString.length-1){a.hint=a.unavailableEditPosition;a.testPosition=this.testString.length;return false}c=this.findEditPositionFrom(a.testPosition+1,true);if(g){d=new wijInputResult;d.hint=d.unknown;f=true;while(f){f=false;if(c===-1){a.hint=a.unavailableEditPosition;a.testPosition=this.testString.length;return false}j=this.descriptors[b];if(j.isAssigned&&!this.testChar(this.testString.charAt(b),c,d)){a.hint=d.hint;a.testPosition=c;return false}if(b!==l){b=this.findEditPositionFrom(b+1,true);c=this.findEditPositionFrom(c+1,true);f=true;continue}}if(d.hint>a.hint)a.hint=d.hint}if(!k){if(g)while(b>=e){i=this.descriptors[b];if(i.isAssigned)this.setChar(this.testString.charAt(b),c);else this.resetChar(c);c=this.findEditPositionFrom(c-1,false);b=this.findEditPositionFrom(b-1,false)}this.setString(h,e)}return true},insertAt:function(c,a,b){if(b===undefined)b=new wijInputResult;if(c===undefined)throw"InsertAt: input";if(this.noMask){this.testString=this.testString.substring(0,a)+c+this.testString.substring(a,this.testString.length);b.testPosition=a+c.length-1;return true}if(a>=0&&a<this.testString.length)return this.internalInsertAt(c,a,b,false);b.testPosition=a;b.hint=b.positionOutOfRange;return false},clear:function(a){if(this.noMask){this.testString="";a.hint=a.success;return}if(!this.assignedCharCount)a.hint=a.noEffect;else{a.hint=a.success;for(var b=0;b<this.testString.length;b++)this.resetChar(b)}},isLiteral:function(b){return!b?false:b.charType!==a.literal?b.charType===a.separator:true},testEscapeChar:function(b,a,c){a=a<0?0:a;if(!c)c=this.descriptors[a];return this.isLiteral(c)?this.getSkipLiterals()?b===this.testString.charAt(a):false:(!this.getResetOnPrompt()||b!==this.getPromtChar())&&(!this.getResetOnSpace()||b!==" ")?false:true},testChar:function(c,e,a){if(!b.wij.charValidator.isPrintableChar(c)){a.hint=a.invalidInput;return false}var d=this.descriptors[e];if(!d)return false;if(this.isLiteral(d)){if(this.getSkipLiterals()&&c===this.testString.charAt(e)){a.hint=a.characterEscaped;return true}a.hint=a.nonEditPosition;return false}if(c===this.getPromtChar()){if(this.getResetOnPrompt()){if(this.isEditDesc(d)&&d.isAssigned)a.hint=a.sideEffect;else a.hint=a.characterEscaped;return true}if(!this.getAllowPromptAsInput()){a.hint=a.promptCharNotAllowed;return false}}if(c===" "&&this.getResetOnSpace()){if(this.isEditDesc(d)&&d.isAssigned)a.hint=a.sideEffect;else a.hint=a.characterEscaped;return true}switch(this.mask.charAt(d.maskPosition)){case"L":if(!b.wij.charValidator.isLetter(c)){a.hint=a.letterExpected;return false}if(!b.wij.charValidator.isAsciiLetter(c)&&this.asciiOnly){a.hint=a.asciiCharacterExpected;return false}break;case"a":if(!b.wij.charValidator.isAlphanumeric(c)&&c!==" "){a.hint=a.alphanumericCharacterExpected;return false}if(!b.wij.charValidator.isAciiAlphanumeric(c)&&this.asciiOnly){a.hint=a.asciiCharacterExpected;return false}break;case"?":if(!b.wij.charValidator.isLetter(c)&&c!==" "){a.hint=a.letterExpected;return false}if(b.wij.charValidator.isAsciiLetter(c)||!this.asciiOnly)break;a.hint=a.asciiCharacterExpected;return false;case"A":if(!b.wij.charValidator.isAlphanumeric(c)){a.hint=a.alphanumericCharacterExpected;return false}if(b.wij.charValidator.isAciiAlphanumeric(c)||!this.asciiOnly)break;a.hint=a.asciiCharacterExpected;return false;case"C":if(!b.wij.charValidator.isAscii(c)&&this.asciiOnly&&c!==" "){a.hint=a.asciiCharacterExpected;return false}break;case"9":if(!b.wij.charValidator.isDigit(c)&&c!==" "){a.hint=a.digitExpected;return false}break;case"#":if(!b.wij.charValidator.isDigit(c)&&c!=="-"&&c!=="+"&&c!==" "){a.hint=a.digitExpected;return false}break;case"&":if(!b.wij.charValidator.isAscii(c)&&this.asciiOnly){a.hint=a.asciiCharacterExpected;return false}break;case"0":if(!b.wij.charValidator.isDigit(c)){a.hint=a.digitExpected;return false}}if(c===this.testString.charAt(e)&&d.isAssigned)a.hint=a.noEffect;else a.hint=a.success;return true},_testString:function(d,f,a){a.hint=a.unknown;a.testPosition=f;if(d.length){var b=new wijInputResult,c,e;b.testPosition=a.testPosition;b.hint=a.hint;for(c=0;c<d.length;c++){e=d.charAt(c);if(a.testPosition>this.testString.length){a.hint=a.unavailableEditPosition;return false}if(!this.testEscapeChar(e,a.testPosition)){a.testPosition=this.findEditPositionFrom(a.testPosition,true);if(a.testPosition===-1){a.testPosition=this.testString.length;a.hint=a.unavailableEditPosition;return false}}if(!this.testChar(e,a.testPosition,b)){a.hint=b.hint;return false}if(b.hint>a.hint)a.hint=b.hint;a.testPosition+=1;if(a.testPosition===this.testString.length)break}a.testPosition-=1}return true},"set":function(b,a){if(a===undefined)a=new wijInputResult;if(b===undefined)throw"SetFromPos: input parameter is null or undefined.";a.hint=a.unknown;a.testPosition=0;if(!b.length){this.clear(a);return true}if(this.noMask){this.testString=b;return true}if(!this.testSetString(b,a.testPosition,a))return false;var c=this.findAssignedEditPositionFrom(a.testPosition+1,true);c!==-1&&this.resetString(c,this.testString.length-1);return true},resetString:function(a,b){if(this.noMask){this.testString="";return}a=this.findAssignedEditPositionFrom(a,true);if(a!==-1){b=this.findAssignedEditPositionFrom(b,false);while(a<=b){a=this.findAssignedEditPositionFrom(a,true);this.resetChar(a);a++}}},setString:function(d,a){for(var b,c=0;c<d.length;c++){b=d.charAt(c);if(!this.testEscapeChar(b,a))a=this.findEditPositionFrom(a,true);if(a<0||a>=this.testString.length)return;this.setChar(b,a);a++}},testSetString:function(a,b,c){if(a.length>this.testString.length)a=a.substring(0,this.testString.length);if(this._testString(a,b,c)){this.setString(a,b);return true}return false},toString:function(f,i,h,d,e){var k=this.inputWidget.options.text||"",o,n,l,p,c,q,j,g,m;k=b.trim(k);if(this.inputWidget.options.showNullText&&!this.inputWidget.isFocused()&&(k===""||k===this.inputWidget.options.nullText))return this.inputWidget.options.nullText;f=f===undefined?!this.isPassword():f;i=i===undefined?this.getHidePromptOnLeave()?this.inputWidget.isFocused():true:i;h=h===undefined?true:h;if(this.noMask){if(!f){o="";for(n=0;n<this.testString.length;n++)o+=this.getPasswordChar();return o}return this.testString}d=d===undefined?0:d;e=e===undefined?this.testString.length:e;if(e<=0)return"";if(d<0)d=0;if(d>=this.testString.length)return"";l=this.testString.length-d;if(e>l)e=l;if((!this.isPassword()||f)&&i&&h){p=this.testString.substring(d,e-d);return p}c="";q=d+e-1;for(j=d;j<=q;j++){g=this.testString.charAt(j);m=this.descriptors[j];switch(m.charType){case a.editOptional:case a.editRequired:if(!m.isAssigned)break;if(!this.isPassword()||f){c=c+g;continue}c=c+this.getPasswordChar();continue;case a.editRequired|a.editOptional:c=c+g;continue;case a.separator:case a.literal:if(!h)continue;c=c+g;continue;default:c=c+g;continue}if(i){c=c+g;continue}c=c+" ";continue}return c},isEditDesc:function(b){return this.noMask?true:b.charType!==a.editRequired?b.charType===a.editOptional:true},isEditPos:function(a){if(this.noMask)return true;if(a<0||a>=this.testString.length)return false;var b=this.descriptors[a];return this.isEditDesc(b)},internalRemoveAt:function(d,e,c,p){if(this.noMask){try{this.testString=this.testString.substring(0,d)+this.testString.substring(e+1,this.testString.length);c.testPosition=d}catch(q){}return true}var m=new wijInputResult,j,i,b,l,a,n,g,o,f,k,h=this.findAssignedEditPositionFrom(this.testString.length-1,false);b=this.findEditPositionInRange(d,e,true,0);c.hint=c.noEffect;if(b===-1||b>h){c.testPosition=d;return true}c.testPosition=d;l=e<h;if(this.findAssignedEditPositionInRange(d,e,true)!==-1)c.hint=c.success;if(l){a=this.findEditPositionFrom(e+1,true);n=a;d=b;g=true;while(g){g=false;j=this.testString.charAt(a);o=this.descriptors[a];if((j!==this.getPromtChar()||o.isAssigned)&&!this.testChar(j,b,m)){c.hint=m.hint;c.testPosition=b;return false}if(a!==h){a=this.findEditPositionFrom(a+1,true);b=this.findEditPositionFrom(b+1,true);g=true;continue}}if(c.sideEffect>c.hint)c.hint=c.sideEffect;if(p)return true;a=n;b=d;f=true;while(f){f=false;i=this.testString.charAt(a);k=this.descriptors[a];if(i===this.getPromtChar()&&!k.isAssigned)this.resetChar(b);else{this.setChar(i,b);this.resetChar(a)}if(a!==h){a=this.findEditPositionFrom(a+1,true);b=this.findEditPositionFrom(b+1,true);f=true;continue}}d=b+1}d<=e&&this.resetString(d,e);return true},removeAt:function(c,b,a){if(typeof b==="undefined")b=c;if(!a)a=new wijInputResult;if(b>=this.testString.length){a.testPosition=b;a.hint=a.positionOutOfRange;return false}if(c>=0&&c<=b)return this.internalRemoveAt(c,b,a,false);a.testPosition=c;a.hint=a.positionOutOfRange;return false}};d=function(b,a){this.caseConversion="none";this.maskPosition=b;this.charType=a};d.prototype={isAssigned:false,maskPosition:0}})(jQuery);