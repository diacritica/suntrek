/*
 *
 * Wijmo Library 2.2.0
 * http://wijmo.com/
 *
 * Copyright(c) GrapeCity, Inc.  All rights reserved.
 * 
 * Dual licensed under the Wijmo Commercial or GNU GPL Version 3 licenses.
 * licensing@wijmo.com
 * http://wijmo.com/license
 *
 *
 **/
(function(a){"use strict";a.widget("wijmo.wijpiechart",a.wijmo.wijchartcore,{options:{radius:null,innerRadius:0,chartLabelFormatter:null,labels:{style:{},formatString:"",formatter:null,connectorStyle:{},position:"inside",offset:10},animation:{enabled:true,duration:400,easing:">",offset:10},seriesTransition:{enabled:true,duration:1e3,easing:"bounce"},seriesList:[],mouseDown:null,mouseUp:null,mouseOver:null,mouseOut:null,mouseMove:null,click:null},_create:function(){var b=this,c=b._getDefFill();a.wijmo.wijchartcore.prototype._create.apply(b,arguments);b.chartElement.addClass("wijmo-wijpiechart");a.each(this.options.seriesStyles,function(b,a){if(!a.fill)a.fill=c[b]})},destroy:function(){var f=this,e=f.chartElement,b=e.data("fields"),c=b&&b.sectors,d=b&&b.labels;e.removeClass("wijmo-wijpiechart");a.wijmo.wijchartcore.prototype.destroy.apply(this,arguments);c&&c.length&&a.each(c,function(b,a){a=null});d&&d.length&&a.each(d,function(b,a){a=null});e.data("fields",null)},_isPieChart:function(){return true},getSector:function(b){var a=this.chartElement.data("fields");return a&&a.chartElements?a.chartElements.sectors[b]:null},_bindData:function(){var f=this,h=f.options,g=h.dataSource,e=h.data,i=[],c,d,b;if(g&&e){c=e.label;d=e.value;b=e.offset;if(c&&c.bind)c=f._getBindData(g,c.bind);if(d&&d.bind)d=f._getBindData(g,d.bind);if(b&&b.bind)b=f._getBindData(g,b.bind);if(c&&a.isArray(c)&&c.length&&d&&a.isArray(d)&&d.length){a.each(d,function(e,h){var g,f=0;if(e>=0&&e<c.length)g=c[e];if(b&&a.isArray(d)&&b.length&&e>=0&&e<b.length)f=typeof b[e]==="undefined"?0:b[e];i.push({data:h,label:g,offset:f,legendEntry:true})});h.seriesList=i}}},_getSeriesFromTR:function(i,e,h){var d=null,g=null,b=null,f=null,c=null;e.length&&e.each(function(){g=a("th",a(this));d=a.trim(g.text());b=a("td",a(this));if(b.length)f=parseFloat(a.trim(a(b[0]).text()));c={label:d,legendEntry:true,data:f};h.push(c)})},_showSerieEles:function(a){var b=this.options.showChartLabels;if(a.sector){a.sector.show();a.sector.shadow&&a.sector.shadow.show();a.sector.tracker&&a.sector.tracker.show()}a.label&&b&&a.label.show()},_hideSerieEles:function(a){if(a.sector){a.sector.hide();a.sector.shadow&&a.sector.shadow.hide();a.sector.tracker&&a.sector.tracker.hide()}a.label&&a.label.hide()},_hasAxes:function(){return false},_mouseDown:function(){a.wijmo.wijchartcore.prototype._mouseDown.apply(this,arguments)},_mouseUp:function(){a.wijmo.wijchartcore.prototype._mouseUp.apply(this,arguments)},_mouseOver:function(){a.wijmo.wijchartcore.prototype._mouseOver.apply(this,arguments)},_mouseOut:function(){a.wijmo.wijchartcore.prototype._mouseOut.apply(this,arguments)},_mouseMove:function(){a.wijmo.wijchartcore.prototype._mouseMove.apply(this,arguments)},_click:function(){a.wijmo.wijchartcore.prototype._click.apply(this,arguments)},_paintTooltip:function(){var c=this,d=c.chartElement,b=d.data("fields");a.wijmo.wijchartcore.prototype._paintTooltip.apply(this,arguments);if(c.tooltip&&b)if(b.trackers&&b.trackers.length){c.tooltip.setSelector(a(".wijchart-canvas-object",d[0]));c.tooltip.setOptions({relatedElement:b.trackers[0]})}},_paintPlotArea:function(){var b=this,c=b.options,d=b.canvasBounds,g=d.endX-d.startX,f=d.endY-d.startY,e=c.radius;if(!e)e=Math.min(g,f)/2;else{if(g<2*e)e=g/2;if(f<2*e)e=f/2}d.startX+=g/2-e;d.endX=d.startX+2*e;d.startY+=f/2-e;d.endY=d.startY+2*e;if(b.chartElement.data("fields"))b.chartElement.data("fields").seriesEles=null;b.chartElement.wijpie({canvas:b.canvas,tooltip:b.tooltip,bounds:d,radius:e,widgetName:b.widgetName,innerRadius:c.innerRadius,seriesList:c.seriesList,seriesStyles:c.seriesStyles,seriesHoverStyles:c.seriesHoverStyles,seriesTransition:c.seriesTransition,showChartLabels:c.showChartLabels,disabled:c.disabled,textStyle:c.textStyle,chartLabelStyle:c.chartLabelStyle,chartLabelFormatString:c.chartLabelFormatString,chartLabelFormatter:c.chartLabelFormatter,labels:c.labels,shadow:c.shadow,animation:c.animation,culture:b._getCulture(),mouseDown:a.proxy(b._mouseDown,b),mouseUp:a.proxy(b._mouseUp,b),mouseOver:a.proxy(b._mouseOver,b),mouseOut:a.proxy(b._mouseOut,b),mouseMove:a.proxy(b._mouseMove,b),click:a.proxy(b._click,b)})},_getTooltipText:function(e,d){var c=a(d.node),b,f;if(c.data("owner"))c=c.data("owner");b=c.data("wijchartDataObj");f={data:b,value:b.value,label:b.label,total:b.total,target:d,fmt:e};return a.proxy(e,f)()}})})(jQuery);(function(a){"use strict";a.fn.extend({wijpie:function(b){var D=function(c,d,e){b.shadow&&a.wijchart.paintShadow(c,d,e)},C=a.wijchart.getDiffAttrs,y=a.wijraphael.addClass,o=a.wijraphael.getPositionByAngle,c=this,O=b.bounds,i=b.widgetName,j=b.canvas,f=b.animation,H=b.seriesList,V=b.seriesStyles,Q=b.seriesHoverStyles,k=b.radius,r=b.innerRadius,l=b.seriesTransition,T=b.showChartLabels,W=b.textStyle,m=b.labels||{style:{},formatString:"",formatter:null,connectorStyle:{},position:"inside",offset:10},S=a.extend(true,{},W,b.chartLabelStyle,m.style),u=m.formatString||b.chartLabelFormatString,q=m.formatter||b.chartLabelFormatter,X=b.culture,n=b.disabled,I=b.mouseDown,M=b.mouseUp,K=b.mouseOver,L=b.mouseOut,J=b.mouseMove,P=b.click,N=b.tooltip,d=c.data("fields")||{},p=d.chartElements||{},v=d.aniSectorAttrs,w=d.aniLabelAttrs,E=[],F=[],A=[],g=[],x=[],e=0,t=0,Y=O.startX,Z=O.startY,G=[],B,h,s,z=j.set();function U(){var b={x:0,y:0},d=a.isFunction;N&&N.setTargets(x);a(".wijpiechart",c[0]).live("mousedown."+i,function(f){if(n)return;var b=a(f.target),e;if(b.data("owner"))b=b.data("owner");e=b.data("wijchartDataObj");if(!e)return;d(I)&&I.call(c,f,e)}).live("mouseup."+i,function(f){if(n)return;var b=a(f.target),e;if(b.data("owner"))b=b.data("owner");e=b.data("wijchartDataObj");if(!e)return;d(M)&&M.call(c,f,e)}).live("mouseover."+i,function(o){if(n)return;var k=a(o.target),h,m,p=f&&f.enabled,l,e,g,i,j;if(k.data("owner"))k=k.data("owner");h=k.data("wijchartDataObj");if(!h)return;m=h.pieID||"";l=h.index;e=c.data("fields").chartElements["sectors"+m][l];g=e.showAnimationTimer;i=e.hideAnimationTimer;j=e.explodeAnimationShowing;d(K)&&K.call(c,o,h);if(e.removed)return;e.wijAttr(h.hoverStyle);if(p){if(i){window.clearTimeout(i);i=null;e.hideAnimationTimer=i}if(g){window.clearTimeout(g);g=null;e.showAnimationTimer=null}if(j)return;g=window.setTimeout(function(){var a=f.duration,c=f.easing;if(e.removed)return;b=e.getOffset(f.offset||10);e.offset=b;e.shadow&&!e.shadow.removed&&e.shadow.hide();e.wijAnimate({transform:Raphael.format("t{0},{1}",b.x,b.y)},a,c);e.tracker&&!e.tracker.removed&&e.tracker.wijAnimate({transform:Raphael.format("t{0},{1}",b.x,b.y)},a,c);j=true;e.explodeAnimationShowing=j},150);e.showAnimationTimer=g}}).live("mouseout."+i,function(o){if(n)return;var k=a(o.target),g,m,p=f&&f.enabled,l,e,i,h,j;if(k.data("owner"))k=k.data("owner");g=k.data("wijchartDataObj");if(!g)return;m=g.pieID||"";l=g.index;e=c.data("fields").chartElements["sectors"+m][l];i=e.showAnimationTimer;h=e.hideAnimationTimer;j=e.explodeAnimationShowing;d(L)&&L.call(c,o,g);if(e.removed)return;if(g.style.segment)delete g.style.segment;e.wijAttr(g.style);if(p){if(h){window.clearTimeout(h);h=null;e.hideAnimationTimer=h}if(i){window.clearTimeout(i);i=null;e.showAnimationTimer=i}if(!j)return;h=window.setTimeout(function(){var a=f.duration,c=f.easing;b=e.offset;e.shadow&&!e.shadow.removed&&e.shadow.show();!e.removed&&e.wijAnimate({transform:"t0,0"},a,c);e.tracker&&!e.tracker.removed&&e.tracker.wijAnimate({transform:"t0,0"},a,c);e.shadow&&!e.shadow.removed&&e.shadow.wijAnimate({transform:"t0,0"},a,c);b={x:0,y:0};j=false;e.explodeAnimationShowing=j},150);e.hideAnimationTimer=h}}).live("mousemove."+i,function(f){if(n)return;var b=a(f.target),e;if(b.data("owner"))b=b.data("owner");e=b.data("wijchartDataObj");if(!e)return;d(J)&&J.call(c,f,e)}).live("click."+i,function(f){if(n)return;var b=a(f.target),e;if(b.data("owner"))b=b.data("owner");e=b.data("wijchartDataObj");if(!e)return;d(P)&&P.call(c,f,e)})}function R(){a(".wijpiechart",c[0]).die(i).die("."+i)}j.customAttributes.segment=function(h,i,d,b,g,f){var e=null,c=.01;if(b-d>360-c)b-=c;else if(b-d<c)b+=c;if(f)e=a.wijchart.donut(h,i,g,f,d,b);else e=a.wijchart.sector(h,i,g,d,b);return{path:e}};a.each(H,function(b,a){if(a&&typeof a.data==="number")t+=a.data});a.each(H,function(d,c){var J=a.extend({opacity:1,stroke:"gray","stroke-width":1},V[d]),L=360*c.data/t,H=Y+k,I=Z+k,P,b,f,p,i,O,n,K,U,R=m.position,W=m.connectorStyle,ab=m.offset,M,N;s=c.pieID;c=a.extend(true,{offset:0},c);if(c.offset){P=o(H,I,c.offset,e+L/2);H=P.x;I=P.y}B=[H,I,e,e+L,k,r].concat(" ");if(v&&l.enabled){J.segment=B;if(d<v.length)h=v[d];else{h=a.extend(true,{},J);h.segment=[H,I,0,360,k,r].concat(" ")}b=j.path().attr(h);J=C(h,J);!b.removed&&b.wijAnimate(J,l.duration,l.easing,function(){D(b);n&&!n.removed&&!b.removed&&n.attr({path:b.attr("path")});delete J.segment})}else{b=j.path().attr({segment:B});D(b);b.wijAttr(J)}b.angles={start:e,end:e+L};b.getOffset=function(c){var a=o(H,I,c,(b.angles.start+b.angles.end)/2);return{x:a.x-H,y:a.y-I}};b.center={x:H,y:I};b.radius=k;if(r)b.innerRadius=r;n=b.clone();if(a.browser.msie&&a.browser.version<9)n.attr({opacity:.01,fill:"white","stroke-width":0,"fill-opacity":.01});else n.attr({opacity:.01,fill:"white","fill-opacity":.01});y(a(n.node),"wijchart-canvas-object wijpiechart pietracker wijchart-tracker"+d);a(n.node).data("owner",a(b.node));b.tracker=n;z.push(n);y(a(b.node),"wijchart-canvas-object wijpiechart wijmo-wijpiechart-series-"+d);a(b.node).data("wijchartDataObj",c);if(T){if(R==="outside"){O=o(H,I,k,e+L/2);p=o(H,I,k+ab,e+L/2)}else p=o(H,I,c.offset+k*2/3,e+L/2);i=a.extend(true,{},i,S);if(c.textStyle)i=a.extend(true,i,c.textStyle);K=c.label;if(u&&u.length>0)K=Globalize.format(K,u,X);if(q&&a.isFunction(q)){U={index:d,value:c.data,y:c.data,total:t,chartLabel:K,chartLabelFormatter:q};K=a.proxy(q,U)()}if(w&&l.enabled)if(d<w.length){h=w[d];h.text=K;f=j.text(0,0,"").attr(h);i=C(h,i);i.x=p.x;i.y=p.y;f.wijAnimate(i,l.duration,l.easing)}else f=j.text(p.x,p.y,K).attr(i);else f=j.text(p.x,p.y,K).attr(i);if(R==="outside"){M=(e+L/2)%360;N=f.wijGetBBox();if(M>=90&&M<=270)f.transform(Raphael.format("...T{0},{1}",-N.width/2,0));else f.transform(Raphael.format("...T{0},{1}",N.width/2,0));j.path(Raphael.format("M{0} {1}L{2} {3}",O.x,O.y,p.x,p.y)).attr(W)}y(a(f.node),"wijchart-canvas-object wijpiechart");a(f.node).data("wijchartDataObj",c);x.push(f);g.push(f);F[d]=f.attr()}G.push({label:g[d],sector:b});if(c.visible===false){b.hide();g[d]&&g[d].hide();b.shadow&&b.shadow.hide();n.hide()}E[d]=b.attr();A.push(b);x.push(b);c.style=J;c.hoverStyle=Q[d];c.index=d;c.value=c.data;c.y=c.data;c.total=t;c.type="pie";e+=L});g&&g.length&&a.each(g,function(b,a){a.toFront()});p.sectors=A;if(s){p["sectors"+s]=A;p["labels"+s]=g}p.labels=g;if(!d.chartElements)d.chartElements={};z.toFront();a.extend(true,d.chartElements,p);d.aniSectorAttrs=E;d.aniLabelAttrs=F;d.seriesEles=G;d.trackers=z;c.data("fields",d);R();U()}})})(jQuery);