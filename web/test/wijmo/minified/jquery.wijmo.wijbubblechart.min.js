/*
 *
 * Wijmo Library 2.2.0
 * http://wijmo.com/
 *
 * Copyright(c) GrapeCity, Inc.  All rights reserved.
 * 
 * Dual licensed under the Wijmo Commercial or GNU GPL Version 3 licenses.
 * licensing@wijmo.com
 * http://wijmo.com/license
 *
 *
 **/
(function(a){"use strict";var d=0,c=0,b=0;a.widget("wijmo.wijbubblechart",a.wijmo.wijchartcore,{options:{minimumSize:5,maximumSize:20,sizingMethod:"diameter",animation:{enabled:true,duration:1e3,easing:">"},seriesTransition:{enabled:true,duration:400,easing:">"},seriesList:[],seriesHoverStyles:[{opacity:1,"stroke-width":5},{opacity:1,"stroke-width":5},{opacity:1,"stroke-width":5},{opacity:1,"stroke-width":5},{opacity:1,"stroke-width":5},{opacity:1,"stroke-width":5},{opacity:1,"stroke-width":5},{opacity:1,"stroke-width":5},{opacity:1,"stroke-width":5},{opacity:1,"stroke-width":5},{opacity:1,"stroke-width":5},{opacity:1,"stroke-width":5}],chartLabel:{position:"inside",compass:"north",visible:true,style:{},chartLabelFormatString:""},mouseDown:null,mouseUp:null,mouseOver:null,mouseOut:null,mouseMove:null,click:null},_setOption:function(d,c){var b=this,e=b.options;if(d==="minimumSize"||d==="minimumSize"){if(isNaN(c)||c<0)c=0;e[d]=c;b.redraw()}else if(d==="chartLabel"){a.extend(e.chartLabel,c);b.redraw()}else a.wijmo.wijchartcore.prototype._setOption.apply(b,arguments);if(d==="seriesList"){b.indexs=null;b.bubbleRadius=null}},_create:function(){var b=this,d=b.options,c=b._getDefFill();a.each(d.seriesStyles,function(b,a){if(!a.fill)a.fill=c[b]});b._setLabelOption();a.wijmo.wijchartcore.prototype._create.apply(b,arguments);b.chartElement.addClass("wijmo-wijbubblechart")},_setLabelOption:function(){var b=this.options;if(b.showChartLabels!==true&&b.chartLabel.visible===true)b.chartLabel.visible=false;if(!a.isPlainObject(b.chartLabel.style)&&a.isPlainObject(b.chartLabelStyle))b.chartLabel.style=b.chartLabelStyle},_clearChartElement:function(){var c=this,d=c.options,b=c.chartElement.data("fields");a.wijmo.wijchartcore.prototype._clearChartElement.apply(c,arguments);b&&b.bubbleInfos&&a.each(b.bubbleInfos,function(b,a){a.bubble&&a.bubble.wijRemove();a.dcl&&a.dcl.wijRemove();a.symbol&&a.symbol.wijRemove()});b&&b.bubbles&&c._destroyRaphaelArray(b.bubbles);c.element.removeData("plotInfos");if(!d.seriesTransition.enabled)if(b&&b.bubblesAnimationInfos)b.bubblesAnimationInfos=null},destroy:function(){var b=this;b.chartElement.removeClass("wijmo-wijbubblechart ui-helper-reset");b._destroyEles();a.wijmo.wijchartcore.prototype.destroy.apply(b,arguments)},_destroyEles:function(){var b=this,d=b.element,c=d.data("fields");c.bubbleInfos&&a.each(c.bubbleInfos,function(c,a){b._removeEle(a.bubble);b._removeEle(a.dcl);b._removeEle(a.symbol);a=null});d.removeData("fields");b.bubbleRadius=[]},_removeEle:function(b){if(b){b.node&&a(b.node).removeData();b.wijRemove();b=null}},_paintPlotArea:function(){var b=this,f=this.chartElement,c=b.options,e=c.seriesList,d=e.length,i=[].concat(c.seriesStyles.slice(0,d)),g=[].concat(c.seriesHoverStyles.slice(0,d)),h=b.canvasBounds,j=b.axisInfo.x,k=b.axisInfo.y[0];if(d===0)return;b._prepBubbleData();f.wijbubble({seriesList:e,seriesStyles:i,seriesHoverStyles:g,canvas:b.canvas,bounds:h,xAxisInfo:j,yAxisInfo:k,chartLabel:c.chartLabel,textStyle:c.textStyle,chartLabelStyle:c.chartLabelStyle,chartLabelFormatString:c.chartLabelFormatString,bubbleRadius:b.bubbleRadius,animation:c.animation,seriesTransition:c.seriesTransition,sizingMethod:c.sizingMethod,minimumSize:c.minimumSize,maximumSize:c.maximumSize,mouseDown:a.proxy(b._mouseDown,b),mouseUp:a.proxy(b._mouseUp,b),mouseOver:a.proxy(b._mouseOver,b),mouseOut:a.proxy(b._mouseOut,b),mouseMove:a.proxy(b._mouseMove,b),click:a.proxy(b._click,b),disabled:c.disabled,culture:b._getCulture()});b.tooltipbubbles=[];a.each(f.data("fields").bubbleInfos,function(c,a){b.tooltipbubbles.push(a.bubble);a.dcl&&b.tooltipbubbles.push(a.dcl);a.symbol&&b.tooltipbubbles.push(a.symbol)});b.tooltip&&b.tooltip.setTargets(b.tooltipbubbles)},_paintLegend:function(){var b=this,l=b.options,d=0,n=0,g=0,h=null,m=l.seriesList,q=l.seriesStyles,e=null,k=null,f=null,o=0,p=0,r=0,i=null,j=null,c=null;a.wijmo.wijchartcore.prototype._paintLegend.apply(b,arguments);if(l.legend.visible){if(b.legends.length&&b.legendIcons.length)for(d=0,n=b.legendIcons.length;d<n;d++){h=b.legendIcons[d];h.attr({fill:h.attr("stroke")})}if(!l.legend.reversed)for(d=0,n=m.length;d<n;d++){e=m[d];k=q[d];if(e.legendEntry){if(e.markers)j=e.markers.type;h=b.legendIcons[g];f=h.wijGetBBox();o=f.x+f.width/2;p=f.y+f.height/2;r=Math.min(f.width,f.height);i=e.markerStyle;i=a.extend({fill:k.stroke,stroke:k.stroke,opacity:1},i);if(!j)j="circle";c=b.canvas.paintMarker(j,o,p,r/2);a.wijraphael.addClass(a(c.node),"chart-legend-dot wijchart-canvas-object wijchart-legend");c.attr(i);a(c.node).data("index",d).data("legendIndex",g);h.remove();b.legendIcons[g]=c;if(!!e.visible){if(l.legend.textWidth)a(b.legends[g][0].node).data("dotOpacity",c.attr("opacity")||1);else a(b.legends[g].node).data("dotOpacity",c.attr("opacity")||1);c.attr("opacity",.3)}g++}}else for(d=m.length-1;d>=0;d--){e=m[d];k=q[m.length-1-d];if(e.legendEntry){if(e.markers)j=e.markers.type;h=b.legendIcons[g];f=h.wijGetBBox();o=f.x+f.width/2;p=f.y+f.height/2;i=e.markerStyle;i=a.extend({fill:k.stroke,stroke:k.stroke,opacity:1},i);if(!j)j="circle";c=b.canvas.paintMarker(j,o,p,7);a.wijraphael.addClass(a(c.node),"chart-legend-dot");c.attr(i);h.remove();b.legendIcons[g]=c;if(!!e.visible){if(l.legend.textWidth)a(b.legends[g][0].node).data("dotOpacity",c.attr("opacity")||1);else a(b.legends[g].node).data("dotOpacity",c.attr("opacity")||1);c.attr("opacity",.3)}g++}}}},_getbubbleIndexs:function(m,l){var d=this,e=d.options,o=e.axis.x.max,p=e.axis.x.min,t=e.axis.y.min,s=e.axis.y.max,q=[],u=[],n=[],r=[],f=[],g=[],i=-1,k=-1,h=-1,j=-1;d.bubbleRadius=[];d._prepBubbleData();a.each(e.seriesList,function(v,i){var h=i.data,k=i.markers||{},j=k.type||"circle";if(h.y1===undefined)return true;a.each(h.y1,function(k,x){var w=a.wijbubble.transform(x,e.maximumSize,e.minimumSize,d.canvasBounds,c,b,e.sizingMethod,j),v,i;if(d._isDate(h.x[k]))v=a.toOADate(h.x[k]);else if(isNaN(h.x[k]))v=k;else v=h.x[k];i=h.y[k];if(d._isDate(i))i=a.toOADate(i);q.push(v-w*(o-p)/m);u.push(i-w*(s-t)/l);n.push(v+w*(o-p)/m);r.push(i+w*(s-t)/l);f.push(v);g.push(i);d.bubbleRadius.push(w)})});i=d._getMinIndex(q);k=d._getMinIndex(u);h=d._getMaxIndex(n);j=d._getMaxIndex(r);d.indexs={xMin:{x:f[i],y:g[i],r:d.bubbleRadius[i]},xMax:{x:f[h],y:g[h],r:d.bubbleRadius[h]},yMin:{x:f[k],y:g[k],r:d.bubbleRadius[k]},yMax:{x:f[j],y:g[j],r:d.bubbleRadius[j]}}},_calculateParameters:function(c,b){a.wijmo.wijchartcore.prototype._calculateParameters.apply(this,arguments);var d=this;if(!b.autoMax&&!b.autoMin)return;d._adjust(b,c)},_adjust:function(e,b){var g=e.unitMinor,a=this,l=e.autoMin,k=e.autoMax,f=a.canvasBounds,j={x:f.startX,y:f.startY},i=f.endX-j.x,h=f.endY-j.y,c=b.max,d=b.min;!a.indexs&&a._getbubbleIndexs(i,h);if(b.id==="x"){if(l)d=a._getMinTick(a.indexs.xMin.x,a.indexs.xMin.r,d,c,i,g);if(k)c=a._getMaxTick(a.indexs.xMax.x,a.indexs.xMax.r,d,c,i,g)}else{if(l)d=a._getMinTick(a.indexs.yMin.y,a.indexs.yMin.r,d,c,h,g);if(k)c=a._getMaxTick(a.indexs.yMax.y,a.indexs.yMax.r,d,c,h,g)}if(c!==b.max||d!==b.min){b.min=d;b.max=c;this._calculateMajorMinor(e,b);a._adjust(e,b)}},_getMinTick:function(e,f,a,d,c,b){return(e-a)*c/(d-a)<f?a-b:a},_getMaxTick:function(e,f,c,a,b,d){return(e-c)*b/(a-c)+f>b?a+d:a},_getMinIndex:function(d){var c=-1,b=0;a.each(d,function(c,a){if(c===0)b=a;else if(a<b)b=a});a.each(d,function(a,d){if(d===b){c=a;return false}});return c},_getMaxIndex:function(d){var c=-1,b=0;a.each(d,function(c,a){if(c===0)b=a;else if(a>b)b=a});a.each(d,function(a,d){if(d===b){c=a;return false}});return c},_showSerieEles:function(b){a.each(b,function(b,a){if(a.bubble){a.bubble.show();a.bubble.tracker&&a.bubble.tracker.show()}a.dcl&&a.dcl.show();a.symbol&&a.symbol.show()})},_hideSerieEles:function(b){a.each(b,function(b,a){if(a.bubble){a.bubble.hide();a.bubble.tracker&&a.bubble.tracker.hide()}a.dcl&&a.dcl.hide();a.symbol&&a.symbol.hide()})},_parseTable:function(){if(!this.element.is("table"))return;var e=this,f=e.element,b=e.options,c=a("caption",f),m=a("thead th",f),g=[],n=a("tbody tr",f),l=null,k=null,i=[],j=[],h=[],d=function(b){var c=a.trim(b);if(!isNaN(b))c=parseFloat(b);return c};if(c.length){b.header=a.extend({visible:true,text:a.trim(a(c[0]).text())},b.header);if(c.length>1)b.footer=a.extend({visibel:true,text:a.trim(a(c[1]).text())},b.footer)}b.legend=a.extend({visible:true},b.legend);l=a.trim(m.eq(1).text());n.each(function(e,c){var b=a("td",c);if(b.length>=3){i.push(d(b.eq(0).text()));j.push(d(b.eq(1).text()));h.push(d(b.eq(2).text()))}});k={label:l,legendEntry:true,data:{x:i,y:j,y1:h}};g.push(k);e.options.seriesList=g},_unbindLiveEvents:function(){var b=this;a(".wijbubblechart-bubble",b.chartElement[0]).die(".wijbubblechart").die("wijbubblechart");if(b.tooltip){b.tooltip.destroy();b.tooltip=null}},_paintTooltip:function(){var c=this,b=c.chartElement.data("fields");a.wijmo.wijchartcore.prototype._paintTooltip.apply(this,arguments);if(c.tooltip)if(b&&b.trackers&&b.trackers.length){c.tooltip.setTargets(b.trackers);c.tooltip.setOptions({relatedElement:b.trackers[0]})}},_getTooltipText:function(e,d){var c=a(d.node),b,f;if(c.data("owner"))c=c.data("owner");b=c.data("wijchartDataObj");f={data:b,value:b.value,label:b.label,total:b.total,target:d,fmt:e,x:b.x,y:b.y,y1:b.y1};return a.proxy(e,f)()},_prepBubbleData:function(){var i=this,h=i.options.seriesList,f=-999999999999,g=9999999999999,e;a.each(h,function(c,b){e=b.data;e&&e.y1&&a.each(e.y1,function(b,a){f=Math.max(f,a);g=Math.min(g,a)})});d=f;c=g;b=f-g},getBubble:function(a){return this.chartElement.data("fields").bubbles[a]}});a.fn.extend({wijbubble:function(e){var l=this,d=e,f=l.data("fields")||{},n=0,g=d.bounds,h=d.canvas,C=a.arrayClone(d.seriesList),y=d.seriesStyles,t=d.seriesHoverStyles,H=d.xAxisInfo,I=d.yAxisInfo,j={x:g.startX,y:g.startY},P=g.endX-j.x,N=g.endY-j.y,i=d.chartLabel,p=[],q=[],E=d.mouseDown,M=d.mouseUp,G=d.mouseOver,K=d.mouseOut,F=d.mouseMove,O=d.click,o=[],J=d.disabled,k=h.set(),L=d.culture;function m(d,b){var a=d.bubble,e=d.symbol,c;if(a.type==="circle")a.attr({r:.0001,cx:b.startX,cy:b.endY});else{a.transform("s0.01");c=a.wijGetBBox();a.transform("t"+(b.startX-c.x)+","+(b.endY-c.y)+"s0.001")}e&&e.hide()}function w(){var b=d.animation,k=d.bounds,h=f.bubblesAnimationInfos,i=[],j=f.bubbleInfos,c=d.seriesTransition,e,g,l;if(b&&b.enabled){e=b.duration||400;g=b.easing;a.each(j,function(n,f){var a=f.bubble,j,b,d=a.wijGetBBox();if(a.type==="circle")j={r:a.attr("r"),cx:a.attr("cx"),cy:a.attr("cy")};else j={transform:"S1T0,0","stroke-width":a.attr("stroke-width"),width:d.width,x:d.x,y:d.y};if(h&&c.enabled){b=h[n];if(b){if(a.type==="circle")a.attr({cx:b.cx,cy:b.cy,r:b.r});else{d=a.wijGetBBox();l=b.width/d.width;a.transform("s"+l);d=a.wijGetBBox();a.transform("t"+(b.x-d.x)+","+(b.y-d.y)+"")}e=c.duration;g=c.easing}else m(f,k)}else m(f,k);i.push(j);a.wijAnimate(j,e,g,function(){f.dcl&&f.dcl.attr("opacity",1);f.symbol&&f.symbol.show()})});f.bubblesAnimationInfos=i}else a.each(j,function(b,a){a.dcl&&a.dcl.attr("opacity",1)})}function D(c,d){var b;a.each(c,function(a,c){if(a===d){b=c;return false}});return b}function u(c,d){var b=true;a.each(c,function(a){if(d===a){b=false;return false}});return b}function B(b,d,e,c){var a;if(h[b])a=h[b](d,e,c);return a}function z(d){var b=h.text(0,0,d),a=b.wijGetBBox(),c;c={width:a.width,height:a.height};b.remove();return c}function s(a,f){var d=e.chartLabel.compass||"north",b=z(f),c=a.r;switch(d){case"north":a.y-=c+b.height/2;break;case"south":a.y+=c+b.height/2;break;case"east":a.x+=c+b.width/2;break;case"west":a.x-=c+b.width/2}}function r(f,j){var g=a.extend(true,{},e.textStyle,e.chartLabelStyle,i.style),c=a.round(j,2),b=i.chartLabelFormatString===""?e.chartLabelFormatString:i.chartLabelFormatString,d;if(b&&b.length)c=Globalize.format(c,b,L);d=h.text(f.x,f.y,c).attr(g);return d}function A(l,x,v,m,t,G,F){var j=l.data,E=m.min,I=t.min,H=m.max,C=t.max,J=G/(H-E),K=F/(C-I),z=[],w=e.bubbleRadius,d,A,y;if(j.y1===undefined)return;a.each(j.y1,function(M,Q){if(j.x===undefined||j.y===undefined)return true;var N=j.x[M],R=j.y[M],V=l.markers||{},U=V.type||"circle",W=V.symbol,X=l.invisibleMarkLabels||[],T,S,I,p,O,P,H,L,G,F;if(w){G=w[n];n++}else G=a.wijbubble.transform(Q,e.maximumSize,e.minimumSize,e.bounds,c,b,e.sizingMethod,U);if(m.isTime)N=a.toOADate(N);else if(isNaN(N))N=M;if(t.isTime)R=a.toOADate(R);O=g.startX+(N-E)*J;P=g.startY+(C-R)*K;if(W)H=D(W,M);p=B(U,O,P,G);p.attr(x);if(H){A=H.width||G*2;y=H.height||G*2;L=h.image(H.url,O-G,P-G,A,y)}a.wijraphael.addClass(a(p.node),"wijchart-canvas-object wijbubblechart-bubble");H&&p.attr("opacity",.1);I=a.extend(false,{index:M,bubble:p,style:x,y1:Q,x:N,y:R,type:"bubble",hoverStyle:v},l);if(H){I.symbol=true;I.hoverStyle=a.extend({},v,{opacity:.1});a(L.node).data("wijchartDataObj",I);a.wijraphael.addClass(a(L.node),"wijbubblechart-symbol")}a(p.node).data("wijchartDataObj",I);F=p.clone();if(a.browser.msie&&a.browser.version<9)F.attr({opacity:.01,fill:"white","stroke-width":0,"fill-opacity":.01});else F.attr({opacity:.01,fill:"white","fill-opacity":.01});a(F.node).data("owner",a(p.node));a.wijraphael.addClass(a(F.node),"wijchart-canvas-object wijbubblechart-bubble bubbletracker");p.tracker=F;k.push(F);q.push(p);f.bubbles=q;T={x:O,y:P,r:G};if(i.visible&&u(X,M)){i.position==="outside"&&s(T,Q);d=r(T,Q);d.attr("opacity",0);a(d.node).data("wijchartDataObj",I);a.wijraphael.addClass(a(d.node),"wijbubblechart-label")}S={bubble:p,dcl:d,symbol:L};o.push(S);z.push(S);if(l.visible===false){p.hide();d&&d.hide();F.hide();L&&L.hide()}});f.bubbleInfos=o;p.push(z)}function x(){a.each(C,function(a,d){var c=y[a],b=t[a];A(d,c,b,H,I,P,N,j)})}function v(b,d,i,f,g,e,j,c){var h={mousedown:function(g){if(c)return;var e=a(g.target),f;if(e.data("owner"))e=e.data("owner");f=e.data("wijchartDataObj");d.call(b,g,f)},mouseup:function(f){if(c)return;var d=a(f.target),e;if(d.data("owner"))d=d.data("owner");e=d.data("wijchartDataObj");i.call(b,f,e)},mouseover:function(g){if(c)return;var d=a(g.target),e;if(d.data("owner"))d=d.data("owner");e=d.data("wijchartDataObj");f.call(b,g,e)},mouseout:function(h){if(c)return;var f=a(h.target),d,e;if(f.data("owner"))f=f.data("owner");d=f.data("wijchartDataObj");e=d.bubble;if(d.symbol)return;if(!d.hoverStyle)e&&e.attr({opacity:"1"});else{e.attr(d.style);d.style.opacity&&e.attr("opacity",d.style.opacity)}g.call(b,h,d)},mousemove:function(h){if(c)return;var g=a(h.target),d,f;if(g.data("owner"))g=g.data("owner");d=g.data("wijchartDataObj");f=d.bubble;if(!d.hoverStyle)f&&f.attr({opacity:"0.8"});else f.attr(d.hoverStyle);e.call(b,h,d)},click:function(f){if(c)return;var d=a(f.target),e;if(d.data("owner"))d=d.data("owner");e=d.data("wijchartDataObj");j.call(b,f,e)}};a.each(["click","mouseover","mouseout","mousemove","mousedown","mouseup"],function(d,c){a(".bubbletracker",b).bind(c+".wijbubblechart",h[c])})}x();f.seriesEles=p;w();k.toFront();f.trackers=k;v(l,E,M,G,K,F,O,J);l.data("fields",f)}});a.wijbubble={transform:function(n,k,e,c,o,j,g,i){var f,b=n,h=k-e,m=c.endX-c.startX,l=c.endY-c.startY;if(b<0)b=0;if(j===0)b=1;else b/=d;b=a.wijbubble.transformByArea(b,g,i);b*=h;b+=e;f=Math.min(m,l);b*=f/200;return b},transformByArea:function(d,b,c){var a=d;if(b==="area")switch(c){case"circle":a=Math.sqrt(a/Math.PI);break;case"tri":case"invertedTri":a=Math.sqrt(a/(3*Math.sin(Math.PI/6)*Math.cos(Math.PI/6)));break;case"box":a=Math.sqrt(a/2);break;case"diamond":case"cross":a=Math.sqrt(a/2);break;default:a=Math.sqrt(4*a/Math.PI)}return a}}})(jQuery);