/*
 *
 * Wijmo Library 2.2.0
 * http://wijmo.com/
 *
 * Copyright(c) GrapeCity, Inc.  All rights reserved.
 * 
 * Dual licensed under the Wijmo Commercial or GNU GPL Version 3 licenses.
 * licensing@wijmo.com
 * http://wijmo.com/license
 *
 *
 **/
(function(a){"use strict";var r="wijmo-wijupload",j="wijmo-wijupload-fileRow",d="."+j,u="wijmo-wijupload-filesList",t="wijmo-wijupload-commandRow",i="wijmo-wijupload-uploadAll",h="wijmo-wijupload-cancelAll",s="wijmo-wijupload-buttonContainer",m="wijmo-wijupload-upload",e="."+m,l="wijmo-wijupload-cancel",n="."+l,v="wijmo-wijupload-file",f="wijmo-wijupload-progress",k="wijmo-wijupload-loading",w="ui-widget-content",o="ui-corner-all",x="ui-state-highlight",q,p,b=function(a){if(a.indexOf("\\")>-1)a=a.substring(a.lastIndexOf("\\")+1);return a},g=function(d){var e=d.files,c="";if(e){a.each(e,function(d,a){c+=b(a.name)+"; "});if(c.length)c=c.substring(0,c.lastIndexOf(";"))}else c=b(d.value);return c},c=function(d){var b=d.files,c=0;b&&b.length>0&&a.each(b,function(b,a){if(a.size)c+=a.size});return c};q=function(l,f,h){var e,d=a("input",f),k=function(a){if(a){a.abort();a=null}},j=function(a){if(a)a=null},i=function(){var e=this,l=d.get(0).files,m=[],i=0,n=0,p=function(j,h){var f=new XMLHttpRequest;f.open("POST",h,true);f.setRequestHeader("Wijmo-RequestType","XMLHttpRequest");f.setRequestHeader("Cache-Control","no-cache");f.setRequestHeader("Wijmo-FileName",j);f.setRequestHeader("Content-Type","application/octet-stream");f.upload.onprogress=function(h){if(h.lengthComputable){var f;if(a.isFunction(e.onProgress)){f={supportProgress:true,loaded:n+h.loaded,total:c(d[0]),fileName:b(e.currentFile.name),fileNameList:g(d[0]).split("; ")};e.onProgress(f)}}};f.onreadystatechange=function(d){if(this.readyState===4){var c=this.responseText,b;n+=l[i].size;i++;if(l.length>i)o(l[i]);else if(a.isFunction(e.onComplete)){b={e:d,response:c,supportProgress:true};e.onComplete(b)}}};m.push(f);return f},o=function(a){var c=b(a.name),d=p(c,h);e.currentFile=a;d.send(a)};e.fileRow=f;e.inputFile=d;e.upload=function(){o(l[i])};e.cancel=function(){a.each(m,function(b,a){k(a)});a.isFunction(e.onCancel)&&e.onCancel()};e.destroy=function(){a.each(m,function(b,a){j(a)})};e.updateAction=function(a){h=a};e.onCancel=null;e.onComplete=null;e.onProgress=null};e=new i;return e};p=function(n,j,l){var i,d=a("input",j),m=d.attr("id"),e="wijUploadForm_"+n,b=a("#"+e),g="wijUploadIfm_"+m,f=true,c=a('<iframe id="'+g+'" name="'+g+'">'),k=function(c,a){b.empty();b.attr("target",c.attr("name"));if(a){a.parent().append(a.clone());b.append(a)}b.submit()},p=function(a){a.attr("src","javascript".concat(":false;"))},o=function(a,c){if(c&&b){b.remove();b=null}if(a){a.remove();a=null}},h;if(b.length===0){b=a('<form method="post" enctype="multipart/form-data"></form>');b.attr("action",l).attr("id",e).attr("name",e).appendTo("body")}c.css("position","absolute").css("top","-1000px").css("left","-1000px");c.appendTo("body");h=function(){var e=this;e.fileRow=j;e.iframe=c;e.inputFile=d;e.upload=function(){var b;k(c,d);if(a.isFunction(e.onProgress)){b={supportProgress:false,loaded:1,total:1};e.onProgress(b)}};e.doPost=function(){k(c)};e.cancel=function(){p(c);a.isFunction(e.onCancel)&&e.onCancel()};e.updateAction=function(a){l=a;b.attr("action",a)};e.destroy=function(a){o(c,a)};e.onCancel=null;e.onComplete=null;e.onProgress=null;c.bind("load",function(i){if(!a.browser.safari)if(f&&!e.autoSubmit){f=false;return}if(c.attr("src")==="javascript".concat(":false;"))return;var g=i.target,d,b,h;try{b=g.contentDocument?g.contentDocument:window.frames[0].document;if(b.XMLDocument)d=b.XMLDocument;else if(b.body)d=b.body.innerHTML;else d=b;if(a.isFunction(e.onComplete)){h={e:i,response:d,supportProgress:false};e.onComplete(h)}}catch(j){d=""}})};i=new h;return i};a.widget("wijmo.wijupload",{options:{action:"",autoSubmit:false,change:null,upload:null,totalUpload:null,progress:null,totalProgress:null,complete:null,totalComplete:null,maximumFiles:0,multiple:false,accept:"",localization:{}},_create:function(){var b=this,e=b.options,d=+new Date,c=b.supportXhr();if(window.wijmoApplyWijTouchUtilEvents)a=window.wijmoApplyWijTouchUtilEvents(a);b.filesLen=0;b.totalUploadFiles=0;b.useXhr=c;b.id=d;b._createContainers();b._createUploadButton();b._createFileInput();b._bindEvents();e.disabled&&b.disable();b.element.is(":hidden")&&b.element.wijAddVisibilityObserver&&b.element.wijAddVisibilityObserver(function(){b._applyInputPosition();b.element.wijRemoveVisibilityObserver&&b.element.wijRemoveVisibilityObserver()},"wijupload")},_setOption:function(d,c){var b=this;a.Widget.prototype._setOption.apply(this,arguments);if(d==="disabled")b._handleDisabledOption(c,b.upload);else if(d==="accept")b.input&&b.input.attr("accept",c)},_handleDisabledOption:function(b,c){var a=this;if(b){if(!a.disabledDiv)a.disabledDiv=a._createDisabledDiv(c);a.disabledDiv.appendTo("body")}else if(a.disabledDiv){a.disabledDiv.remove();a.disabledDiv=null}},_createDisabledDiv:function(d){var g=this,b=d?d:g.upload,c=b.offset(),f=b.outerWidth(),e=b.outerHeight();return a("<div></div>").addClass("ui-disabled").css({"z-index":"99999",position:"absolute",width:f,height:e,left:c.left,top:c.top})},destroy:function(){var b=this;b.upload.removeClass(r);b.upload.undelegate(b.widgetName).undelegate("."+b.widgetName);b.input.remove();b.addBtn.remove();b.filesList.remove();b.commandRow.remove();b.isCreateByInput===true&&b.element.css({display:""}).unwrap();if(b.uploaders){a.each(b.uploaders,function(b,a){a.destroy&&a.destroy(true);a=null});b.uploaders=null}if(b.disabledDiv){b.disabledDiv.remove();b.disabledDiv=null}},widget:function(){return this.upload},supportXhr:function(){var a=false;if(typeof(new XMLHttpRequest).upload==="undefined")a=false;else a=true;return a},_createContainers:function(){var b=this,e,d,c=b.element;if(c.is(":input")&&c.attr("type")==="file"){b.isCreateByInput=true;b.maxDisplay=c.attr("multiple")||b.options.multiple?0:1;b.upload=c.css({display:"none"}).wrap("<div>").parent()}else if(b.element.is("div"))b.upload=c;else throw'The initial markup must be "DIV", "INPUT[type=file]"';b.upload.addClass(r);e=a("<ul>").addClass(u).appendTo(b.upload);d=a("<div>").addClass(t).appendTo(b.upload);b.filesList=e;d.hide();b.commandRow=d;b._createCommandRow(d)},_createCommandRow:function(e){var b=this,d=a("<a>").attr("href","#").text("uploadAll").addClass(i).button({icons:{primary:"ui-icon-circle-arrow-n"},label:b._getLocalization("uploadAll","Upload All")}),c=a("<a>").attr("href","#").text("cancelAll").addClass(h).button({icons:{primary:"ui-icon-cancel"},label:b._getLocalization("cancelAll","Cancel All")});e.append(d).append(c)},_getLocalization:function(c,b){var a=this.options.localization;return a&&a[c]||b},_createUploadButton:function(){var b=this,c=a("<a>").attr("href","#").button({label:b._getLocalization("uploadFiles","Upload files")});c.mousemove(function(a){var d=c.data("button").options.disabled;if(b.input){var e=a.pageX,f=a.pageY;!d&&b.input.offset({left:e+10-b.input.width(),top:f+10-b.input.height()})}});b.addBtn=c;b.upload.prepend(c)},_applyInputPosition:function(){var d=this,a=d.addBtn,b=a.offset(),c=d.cuurentInput;c.offset({left:b.left+a.width()-c.width(),top:b.top}).height(a.height())},_createFileInput:function(){var b=this,d=b.addBtn,f=d.offset(),g=b.element.attr("accept")||b.options.accept,h="wijUpload_"+b.id+"_input"+b.filesLen,c=a("<input>").attr("type","file").prependTo(b.upload),i=b.options.maximumFiles||b.maxDisplay;i!==1&&b.maxDisplay===0&&c.attr("multiple","multiple");g&&c.attr("accept",g);b.cuurentInput=c;b.filesLen++;c.attr("id",h).attr("name",h).css("position","absolute").offset({left:f.left+d.width()-c.width(),top:f.top}).css("z-index","9999").css("opacity",0).height(d.height()).css("cursor","pointer");b.input=c;c.bind("change",function(g){var f,d;if(b._trigger("change",g,a(this))===false)return false;b._createFileInput();f=b._createFileRow(a(this));b._setAddBtnState();if(b.options.autoSubmit){d=a(e,f);d&&d.click()}c.unbind("change")});b.uploadAll=false},_setAddBtnState:function(){var b=this,d=b.options.maximumFiles||b.maxDisplay,c=b.addBtn,e;if(!d)return;if(!c)return;if(!b.maskDiv)b.maskDiv=a("<div></div>").css("position","absolute").css("z-index","9999").width(c.outerWidth()).height(c.outerHeight()).appendTo(b.upload).offset(c.offset());e=a("li",b.filesList);if(e.length>=d){c.button({disabled:true});b.maskDiv.show();b.input&&b.input.css("left","-1000px")}else{c.button({disabled:false});b.maskDiv.hide()}},_createFileRow:function(h){var c=this,b=a("<li>"),n,k,i,e=a("<span>").addClass(s),q=a("<a>").attr("href","#").text("upload").addClass(m).button({text:false,icons:{primary:"ui-icon-circle-arrow-n"},label:c._getLocalization("upload","upload")}),p=a("<a>").attr("href","#").text("cancel").addClass(l).button({text:false,icons:{primary:"ui-icon-cancel"},label:c._getLocalization("cancel","cancel")});b.addClass(j).addClass(w).addClass(o);b.append(h);h.hide();n=a("<span>"+g(h[0])+"</span>").addClass(v).addClass(x).addClass(o);b.append(n);b.append(e);k=a("<span />").addClass(f);e.append(k);e.append(q).append(p);b.appendTo(c.filesList);i=a(d,c.upload);if(i.length){c.commandRow.show();c._createUploader(b);c._resetProgressAll()}return b},_createUploader:function(e){var b=this,h=a("input",e),g=b.options.action,d;if(b.useXhr)d=q(b.id,e,g);else d=p(b.id,e,g);d.onCancel=function(){var a=this;b._trigger("cancel",null,a.inputFile);b.totalUploadFiles--;b.totalUploadFiles===0&&b.uploadAll&&b._trigger("totalComplete")};if(b._wijUpload()){d.onProgress=function(c){var d=a("."+f,this.fileRow),e={sender:c.fileName,loaded:c.loaded,total:c.total},g=this.inputFile.attr("id");if(c.supportProgress){d.html(Math.round(1e3*c.loaded/c.total)/10+"%");if(c.fileNameList)e.fileNameList=c.fileNameList;b._trigger("progress",null,e);b._progressTotal(g,c.loaded)}else d.addClass(k)};d.onComplete=function(e){var d=this,h=d.inputFile.attr("id"),j=b.uploaders[h],i=c(d.inputFile[0]),g=a("."+f,d.fileRow);b._trigger("complete",e.e,d.inputFile);g.removeClass(k);g.html("100%");b._removeFileRow(d.fileRow,j,true);b._progressTotal(h,i);b.totalUploadFiles--;b.totalUploadFiles===0&&b.uploadAll&&b._trigger("totalComplete",e.e,e)}}if(typeof b.uploaders==="undefined")b.uploaders={};b.uploaders[h.attr("id")]=d},_progressTotal:function(f,e){var b=this,a=b.progressAll,c,d;if(!b.uploadAll)return;if(a&&a.loadedSize){a.loadedSize[f]=e;c=b._getLoadedSize(a.loadedSize);d=a.totalSize}b._trigger("totalProgress",null,{loaded:c,total:d})},_getLoadedSize:function(c){var b=0;a.each(c,function(c,a){b+=a});return b},_getTotalSize:function(){var d=this,b=0;d.uploaders&&a.each(d.uploaders,function(d,a){b+=c(a.inputFile[0])});return b},_resetProgressAll:function(){this.progressAll={totalSize:0,loadedSize:{}}},_wijUpload:function(){return true},_wijcancel:function(){},_upload:function(){},_bindEvents:function(){var b=this,f=b.progressAll;b.upload.delegate(n,"click."+b.widgetName,function(){var i=a(this),h=i.parents(d),e=a("input",h[0]),g=b.uploaders[e.attr("id")];b._wijcancel(e);b._wijUpload()&&g&&g.cancel();if(f){f.totalSize-=c(e[0]);if(f.loadedSize[e.val()])delete f.loadedSize[e.val()]}b._removeFileRow(h,g,false)});b.upload.delegate(e,"click."+b.widgetName,function(g){var h=a(this),f=h.parents(d),e=a("input",f[0]),c=b.uploaders[e.attr("id")];if(b._trigger("upload",g,e)===false)return false;if(b.options.autoSubmit){c.autoSubmit=true;if(b._trigger("totalUpload",g,null)===false)return false}b.totalUploadFiles++;b._upload(f);c&&b._wijUpload()&&c.upload()});b.upload.delegate("."+i,"click."+b.widgetName,function(c){b.uploadAll=true;!b.progressAll&&b._resetProgressAll();if(b._trigger("totalUpload",c,null)===false)return false;b.progressAll.totalSize=b._getTotalSize();b._wijuploadAll(a(e,b.filesList[0]));b._wijUpload()&&a(e,b.filesList[0]).each(function(c,b){a(b).click()})});b.upload.delegate("."+h,"click."+b.widgetName,function(){b._resetProgressAll();a(n,b.filesList[0]).each(function(c,b){a(b).click()})})},_wijuploadAll:function(){},_wijFileRowRemoved:function(){this._setAddBtnState()},_removeFileRow:function(f,b,h){var c=this,e,g;if(b)e=b.inputFile.attr("id");f.fadeOut(1500,function(){f.remove();c._wijFileRowRemoved(f,b.inputFile,h);if(c.uploaders[e])delete c.uploaders[e];g=a(d,c.upload);if(g.length){c.commandRow.show();b&&b.destroy&&b.destroy()}else{c.commandRow.hide();c._resetProgressAll();b&&b.destroy&&b.destroy(true)}})},_getFileName:function(a){return b(a)},_getFileNameByInput:function(a){return g(a)},_getFileSize:function(a){return c(a)}})})(jQuery);